<%- include("../../views/partials/user/headerprofile") %>

    <div class="col-md-9">
        <div id="orderModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close " onclick="closeModal()">&times;</span>
                <h2 class="mb-4">Order Details - <span id="modalOrderId"></span></h2>
                <div id="orderDetails">
                    <div class="order-info mb-4">
                        <p><strong>Name:</strong> <span id="modalCustomer"></span></p>
                        <p><strong>Order Date:</strong> <span id="modalDate"></span></p>
                        <p><strong>Payment Status:</strong> <span id="modalPaymentStatus"></span></p>
                    </div>
                    <h3 class="mb-3">Items</h3>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="modalItems">

                            </tbody>
                        </table>

                        <div id="orderSummary" class="mt-4">
                            <p><strong>Subtotal:</strong> ₹<span id="modalSubtotal"></span></p>
                            <p><strong>Discount:</strong> ₹<span id="modalDiscount"></span></p>
                            <p><strong>Shipping:</strong> ₹<span id="modalShipping"></span></p>
                            <p class="h5"><strong>Grand Total:</strong> ₹<span id="modalGrandTotal"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="cancelModal" class="modal">
            <div class="modal-content p-4">
                <h4>Cancel Item</h4>
                <p><strong>Order ID:</strong> <span id="cancelOrderId"></span></p>
                <p style="margin-bottom: 20px;">*Note: Refund amounts may vary based on the cancellation of items in
                    your order. Shipping costs are
                    calculated
                    proportionately, which may affect the total refund.</p>
                <div class="d-flex align-items-start mb-3">
                    <img id="cancelProductImage" src="" alt="Product Image" class="me-3 rounded" width="100"
                        height="100">
                    <div>
                        <p><strong>Product Name:</strong> <span id="cancelProductName"></span></p>
                        <p><strong>Size:</strong> <span id="cancelProductSize"></span></p>
                        <p><strong>Color:</strong> <span id="cancelProductColor"></span></p>
                        <p><strong>Price:</strong> ₹<span id="cancelProductPrice"></span></p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="cancelComment">Reason for cancellation:</label>
                    <textarea id="cancelComment" class="form-control" rows="3"
                        placeholder="Enter your reason"></textarea>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <button id="submitCancellation" class="btn btn-primary">Submit</button>
                    <button onclick="closeModal('cancelModal')" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>

        <div id="returnModal" class="modal">
            <div class="modal-content p-4">
                <h4>Return Item</h4>
                <p><strong>Order ID:</strong> <span id="returnOrderId"></span></p>
                <div class="d-flex align-items-start mb-3">
                    <img id="returnProductImage" src="" alt="Product Image" class="me-3 rounded" width="100"
                        height="100">
                    <div>
                        <p><strong>Product Name:</strong> <span id="returnProductName"></span></p>
                        <p><strong>Size:</strong> <span id="returnProductSize"></span></p>
                        <p><strong>Color:</strong> <span id="returnProductColor"></span></p>
                        <p><strong>Price:</strong> ₹<span id="returnProductPrice"></span></p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="returnComment">Reason for return:</label>
                    <textarea id="returnComment" class="form-control" rows="3"
                        placeholder="Enter your reason"></textarea>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <button id="submitReturn" class="btn btn-primary">Submit</button>
                    <button onclick="closeModal('returnModal')" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>




        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h5>Your Orders</h5>
                </div>
                <div class="card-body">
                    <div class="order-list">
                        <% if (orders && orders.length> 0) { %>
                            <% orders.forEach(order=> { %>
                                <div class="order-item" data-order-id="<%= order.orderNumber %>"
                                    data-customer-name="<%= user.name %>" data-order-date="<%= order.createdAt %>"
                                    data-address="<%= order.shippingAddress || 'N/A' %>"
                                    data-items='<%= JSON.stringify(order.items) %>'
                                    data-timeline='<%= JSON.stringify(order.timeline || []) %>'
                                    data-subtotal="<%= order.subtotal || 0 %>"
                                    data-discount="<%= order.discount || 0 %>"
                                    data-shipping="<%= order.shipping || 0 %>"
                                    data-grandtotal="<%= order.grandTotal || 0 %>"
                                    data-paymentStatus="<%= order.paymentStatus || 'N/A' %>">
                                    <div class="order-content">
                                        <h6 class="order-id">Order ID: <%= order.orderNumber || 'N/A' %>
                                        </h6>
                                        <% order.items.forEach(item=> { %>
                                            <div class="product-info row ">
                                                <div class="col-3 col-md-2">
                                                    <img src="/uploads/product-image/<%= item.productImage%>"
                                                        alt="<%= item.productId?.productName || 'Product Image' %>"
                                                        class="product-image">
                                                </div>
                                                <div class="col-9 col-md-10">
                                                    <div class="product-details">
                                                        <h3>
                                                            <%= item.productId?.productName || 'Product Name' %>
                                                        </h3>
                                                        <p>Color: <%= item.variant.color || 'N/A' %>
                                                        </p>
                                                        <p>Size: <%= item.variant.size || 'N/A' %>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="order-details row">
                                                <div class="order-detail col-6 col-md-4">
                                                    <h4>Quantity</h4>
                                                    <p>
                                                        <%= item.quantity %>
                                                    </p>
                                                </div>
                                                <div class="order-detail col-6 col-md-4">
                                                    <h4>Price</h4>
                                                    <p>₹<%= (item.productId?.salePrice || item.productId?.regularPrice
                                                            || 0) * item.quantity %>
                                                    </p>
                                                </div>
                                                <div class="order-detail col-12 col-md-4">
                                                    <h4>Status</h4>
                                                    <span
                                                        class="badge <%= item.badgeClass %> <%= item.orderStatus === 'Failed' ? 'text-danger bg-light' : '' %>">
                                                        <%= item.orderStatus || 'Pending' %>
                                                    </span>
                                                </div>
                                            </div>
                                            <hr>
                                            <% }); %>
                                    </div>
                                    <button class="btn btn-dark btn-outline-secondary btn w-100 mb-1 view-order"
                                        style="font-size: smaller;">
                                        View <i class="bi bi-chevron-down ms-1"></i>
                                    </button>
                                    <% const allDelivered=order.items.every(item=> item.orderStatus === 'Delivered');
                                        const anyFailed = order.paymentStatus === 'Failed' &&
                                        order.items.some(item => item.orderStatus === 'Failed') &&
                                        !order.items.some(item => item.orderStatus === 'canceled');
                                        const paymentCompleted = order.paymentStatus === 'Completed';
                                        %>

                                        <% if (anyFailed) { %>
                                            <button class="btn btn-primary btn w-100 mb-2 pay-now-btn"
                                                data-order-id="<%= order.orderNumber %>">
                                                Retry Payment
                                            </button>
                                            <% } %>

                                                <% if (allDelivered || paymentCompleted) { %>
                                                    <button class="btn btn-success btn w-100 mb-2 invoice-btn"
                                                        data-order-id="<%= order.orderNumber %>">
                                                        Download Invoice
                                                    </button>
                                                    <% } %>

                                                        <div class="order-summary">
                                                            <div class="summary-row">
                                                                <span>Subtotal:</span>
                                                                <span>₹<%= order.subtotal || 0 %></span>
                                                            </div>
                                                            <div class="summary-row">
                                                                <span>Discount :</span>
                                                                <span>-₹<%= order.discount || 0 %></span>
                                                            </div>
                                                            <div class="summary-row">
                                                                <span>Shipping:</span>
                                                                <span>₹40</span>
                                                            </div>
                                                            <div class="summary-row">
                                                                <span>Total:</span>
                                                                <span>₹<%= order.grandTotal || 0 %></span>
                                                            </div>
                                                        </div>
                                </div>
                                <% }); %>
                                    <% } else { %>
                                        <div class="alert alert-warning" role="alert">
                                            You have not ordered anything yet.
                                        </div>
                                        <% } %>
                    </div>
                    <div class="pagination-controls">
                        <% if (currentPage> 1) { %>
                            <a href="?page=<%= currentPage - 1 %>&limit=<%= limit %>"
                                class="btn btn-secondary">Previous</a>
                            <% } %>
                                <span>Page <%= currentPage %> of <%= totalPages %></span>
                                <% if (currentPage < totalPages) { %>
                                    <a href="?page=<%= currentPage + 1 %>&limit=<%= limit %>"
                                        class="btn btn-secondary">Next</a>
                                    <% } %>
                    </div>
                </div>
            </div>
        </div>
        <%- include("../../views/partials/user/footerprofile") %>
            <script src="/js/userBlockCheck.js"></script>
            <script src="/js/orderHandle.js"></script>
            <script src="/js/payNow.js"></script>
            <script src="/js/invoice.js"></script>