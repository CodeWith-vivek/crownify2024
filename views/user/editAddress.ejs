<%- include("../../views/partials/user/headeraddressedit") %>
    <section class="breadcrumb-option" style="    height: 140px;
    background-color: #291616;
    padding-top: 58px;
    padding-bottom: 40px;">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__text">

                        <div class="breadcrumb__links">
                            <a href="/" style="color: white;">Home</a> <span
                                style="padding-right: 10px; font-size: small; padding-left: 10px;"> ></span>
                            <a href="#" style="color:rgb(108, 108, 108) ;">Pages</a><span
                                style="padding-right: 10px; font-size: small; padding-left: 10px;"> ></span>
                            <a href="/profile" style="color:rgb(108, 108, 108) ;">Account</a> <span
                                style="padding-right: 10px; font-size: small; padding-left: 10px;"> ></span>
                            <a href="/user/addAddress" style="color: rgb(109, 109, 109);">Add New Address</a>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="ftco-section">

        <div class="container">

            <div class="row justify-content-center">
                <div class="col-lg-12">
                    <div class="wrap d-md-flex">


                        <div class="login-wrap p-4 p-md-5"
                            style="background-image: url(/assets/images/editAddress2.png); background-size: cover; background-position: center; background-repeat: no-repeat;">
                            <h3 class="mb-3" style="font-weight: 600;">Edit Address</h3>
                            <!-- <% if (messages.error) { %>
                                <div style="color: red;">
                                    <%= messages.error %>
                                </div>
                                <% } %> -->


                            <form method="post" action="/update-address/<%= address._id %>" class="signup-form"
                                id="signform">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="addressType">Address Type:</label>
                                            <select name="addressType" id="addressType" required
                                                style="border-radius: 36px;">
                                             
                                                <option value="Home" <%=address.addressType==='Home' ? 'selected' : ''
                                                    %>
                                                    >
                                                    Home
                                                </option>
                                                <option value="Office" <%=address.addressType==='Office' ? 'selected'
                                                    : '' %>
                                                    >
                                                    Office
                                                </option>
                                                <option value="Other" <%=address.addressType==='Other' ? 'selected' : ''
                                                    %>
                                                    >
                                                    Other
                                                </option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="label" style="width: 300px;" for="name">Full Name ( First and
                                                Last Name )</label>

                                            <input type="text" name="name" class="form-control"
                                                value="<%= address.fullName %>" id="name" required>
                                            <div id="error1" class="error-message"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="label" for="country">Country / Region</label>
                                            <input type="text" class="form-control" name="country" id="country"
                                                value="<%= address.country %>">
                                            <div id="error2" class="error-message"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="label" for="phone">Mobile Number</label>

                                            <input type="text" name="phone" class="form-control"
                                                value="<%= address.mobileNumber %>" id="phone" required>
                                            <div id="error3" class="error-message"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="label" for="pincode">Pincode / Zipcode</label>
                                            <input type="text" class="form-control" name="pincode" id="pincode"
                                                value="<%= address.postalCode %>">
                                            <div id="error4" class="error-message"></div>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="label" style="width: 300px;" for="home">Flat, House
                                                no.,Company</label>
                                            <div class="input-group">
                                                <input type="text" id="home" class="form-control" name="home"
                                                    value="<%= address.flatHouseCompany %>">


                                            </div>


                                            <div id="error5" class="error-message"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="label" for="area">Area, Street</label>
                                            <div class="input-group">
                                                <input type="text" id="area" class="form-control" name="area"
                                                    value="<%= address.areaStreet %>">

                                            </div>


                                            <div id="error6" class="error-message"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="label" for="landmark">Landmark</label>
                                            <div class="input-group">
                                                <input type="text" id="landmark" class="form-control" name="landmark"
                                                    value="<%= address.landmark %>">

                                            </div>


                                            <div id="error7" class="error-message"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="label" for="town">Town / City</label>
                                            <div class="input-group">
                                                <input type="text" id="town" class="form-control" name="town"
                                                    value="<%= address.city %>">

                                            </div>


                                            <div id="error8" class="error-message"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="label" for="state">State /Province</label>
                                            <div class="input-group">
                                                <input type="state" id="state" class="form-control" name="state"
                                                    value="<%= address.state %>">

                                            </div>


                                            <div id="error9" class="error-message"></div>
                                        </div>
                                    </div>


                                    <div class="col-md-12 text-center">
                                        <div class="form-group ">
                                            <button type="submit" class="btn btn-secondary submit "
                                                style="width:170px">Add Address</button>
                                        </div>
                                    </div>
                                </div>

                            </form>

                        </div>
                        <div class="text-wrap p-4 p-lg-5 d-flex img d-flex align-items-end"
                            style="background-image: url(/assets/images/guitarcat.webp);">
                            <div class="text w-100">
                                <h2 class="mb-4">Welcome to Login page</h2>
                                <p>Far far away, behind the word mountains, far from the countries Vokalia and
                                    Consonantia,
                                    there live the blind texts.</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>
    <%- include("../../views/partials/user/footereditAddress") %>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>
         document.addEventListener("DOMContentLoaded", () => {
                const fields = {
                    name: { id: "name", error: "error1", pattern: /^[A-Za-z]+(?: [A-Za-z]+){1,2}$/, message: "Full name required" },
                    country: { id: "country", error: "error2", pattern: /^[A-Za-z]+$/, message: "Country must only contain letters" },
                    phone: { id: "phone", error: "error3", pattern: /^\d{10}$/, message: "Phone number must be 10 digits" },
                    pincode: { id: "pincode", error: "error4", pattern: /^\d{6}$/, message: "Pincode must be 6 digits" },
                    home: { id: "home", error: "error5", custom: value => value.split(' ').length >= 2, message: "Home address must be detailed" },
                    area: { id: "area", error: "error6", pattern: /^[A-Za-z0-9]+$/, message: "Area must only contain letters and numbers" },
                    landmark: { id: "landmark", error: "error7", pattern: /^[A-Za-z0-9]+$/, message: "Landmark must only contain letters and numbers" },
                    town: { id: "town", error: "error8", pattern: /^[A-Za-z]+$/, message: "Town must only contain letters" },
                    state: { id: "state", error: "error9", pattern: /^[A-Za-z]+$/, message: "State must only contain letters" }
                };

                const validateField = (field, isBlur = false) => {
                    const element = document.getElementById(fields[field].id);
                    const errorElement = document.getElementById(fields[field].error);
                    const value = element.value.trim();

                    let isValid = false;
                    if (value === "") {
                        errorElement.style.display = "block";
                        errorElement.innerHTML = `Please enter ${field}`;
                    } else if (fields[field].pattern && !fields[field].pattern.test(value)) {
                        errorElement.style.display = "block";
                        errorElement.innerHTML = fields[field].message;
                    } else if (fields[field].custom && !fields[field].custom(value)) {
                        errorElement.style.display = "block";
                        errorElement.innerHTML = fields[field].message;
                    } else {
                        errorElement.style.display = "none";
                        isValid = true;
                    }

                    return isValid;
                };

             
                for (const field in fields) {
                    const element = document.getElementById(fields[field].id);
                    element.addEventListener("input", () => validateField(field));
                    element.addEventListener("blur", () => validateField(field, true));
                }

             
                document.getElementById("signform").addEventListener("submit", async (event) => {
                    event.preventDefault();
                    let allValid = true;

                    for (const field in fields) {
                        const isFieldValid = validateField(field);
                        if (!isFieldValid) allValid = false;
                    }

                    if (allValid) {
                        const formData = new FormData(event.target);
                        const data = Object.fromEntries(formData.entries());

                        const addressId = window.location.pathname.split('/').pop();

                        try {
                            const response = await fetch(`/update-address/${addressId}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data),
                            });

                            if (response.ok) {
                                const result = await response.json();
                                Swal.fire({
                                    title: 'Success',
                                    text: result.message || 'Address updated successfully',
                                    icon: 'success',
                                    confirmButtonText: 'OK'
                                }).then(() => window.location.href = '/Address');
                            } else {
                                const error = await response.json();
                                Swal.fire({
                                    title: 'Error',
                                    text: error.message || 'Failed to update address',
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                });
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            Swal.fire({
                                title: 'Error',
                                text: 'There was an error updating your address.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    } else {
                        Swal.fire({
                            title: 'Validation Error',
                            text: 'Please correct the errors in the form.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });

        </script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const cartLinks = document.querySelectorAll('.site-header__cart');

                cartLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        console.log('Cart link clicked');

                 
                        e.stopPropagation();

                     
                        window.location.href = '/cart';

                    
                        e.preventDefault();
                    });
                });
            });
        </script>
        <script>
            async function checkUserBlockStatus() {
                try {
                    const response = await fetch("/check-block-status", {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });
                    const data = await response.json();

                    if (data.blocked) {

                        window.location.href = "/login"; // Redirect to the login page or home page
                    }
                } catch (error) {
                    console.error("Error checking block status:", error);
                }
            }

            // Check every 30 seconds
            setInterval(checkUserBlockStatus, 2000);
        </script>